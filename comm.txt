sudo apt update
sudo apt install network-manager -y
sudo systemctl enable NetworkManager
sudo systemctl start NetworkManager

# Create hotspot profile
sudo nmcli con add con-name BoatHotspot ifname wlan0 type wifi ssid "BoatController"
sudo nmcli con modify BoatHotspot wifi-sec.key-mgmt wpa-psk
sudo nmcli con modify BoatHotspot wifi-sec.psk "remote1234"
sudo nmcli con modify BoatHotspot 802-11-wireless.mode ap
sudo nmcli con modify BoatHotspot 802-11-wireless.band bg
sudo nmcli con modify BoatHotspot ipv4.method shared

# Set highest autoconnect priority
sudo nmcli con modify BoatHotspot connection.autoconnect yes
sudo nmcli con modify BoatHotspot connection.autoconnect-priority 0

# Enable and start hotspot
sudo nmcli con up BoatHotspot


nmcli dev wifi list
# Should show BoatController as an access point

# In bridge.py
UDP_IP = '0.0.0.0'  # Listen on all interfaces
UDP_PORT = 12345

# No changes needed to ESP32 code


ESP32_IP = "192.168.50.1"  # Network Manager's default AP gateway
PORT = 12345

sudo nano /etc/systemd/system/boat-system.service


[Unit]
Description=Boat Control System
After=network.target

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/bin/nmcli con up BoatHotspot
ExecStart=/usr/local/bin/start_stream.sh
ExecStart=/usr/bin/python3 /home/pi/bridge.py

[Install]
WantedBy=multi-user.target

sudo systemctl daemon-reload
sudo systemctl enable boat-system

sudo nano /etc/udev/rules.d/99-uart.rules

KERNEL=="ttyAMA0", GROUP="dialout", MODE="0660"
KERNEL=="ttyS0", GROUP="dialout", MODE="0660"


sudo udevadm control --reload-rules
sudo udevadm trigger

systemctl status boat-system




--------------------------------------------------------------------------------


nmcli con show

sudo nano /etc/systemd/system/boat-system.service

ExecStart=/usr/bin/nmcli con up Boathotspot

ExecStart=/usr/bin/nmcli con up BoatHotspot

sudo systemctl daemon-reload
sudo systemctl restart boat-system
sudo systemctl status boat-system  # Verify it's running








ðŸ›  Alternative Robust Solution
If the issue persists, let's create a more reliable startup script:

1. Create a Startup Script
bash
sudo nano /usr/local/bin/boat-start.sh
bash
#!/bin/bash

# Start WiFi hotspot
nmcli con up BoatHotspot

# Start camera stream
/usr/local/bin/start_stream.sh &

# Start UDP-UART bridge
python3 /home/pi/bridge.py
Make executable:

bash
sudo chmod +x /usr/local/bin/boat-start.sh
2. Update the Service File
bash
sudo nano /etc/systemd/system/boat-system.service
Replace with:

ini
[Unit]
Description=Boat Control System
After=network.target

[Service]
ExecStart=/usr/local/bin/boat-start.sh
WorkingDirectory=/home/pi
Restart=always
RestartSec=10
User=pi

# Logging configuration
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=boat-system

[Install]
WantedBy=multi-user.target
3. Enable and Test
bash
sudo systemctl daemon-reload
sudo systemctl enable boat-system
sudo systemctl start boat-system
sudo journalctl -u boat-system -f  # Monitor logs
ðŸ” Troubleshooting Tips
Check WiFi interface status:

bash
nmcli device status
Test hotspot manually:

bash
sudo nmcli con up BoatHotspot
Verify connection details:

bash
nmcli con show BoatHotspot
Check for conflicting services:

bash
sudo systemctl stop hostapd dnsmasq  # Stop legacy services if present
sudo systemctl disable hostapd dnsmasq
Increase startup delay (if needed):

bash
sudo nano /etc/systemd/system/boat-system.service
Add under [Unit]:

ini
After=network.target
StartLimitIntervalSec=120
ðŸ’» Expected Successful Output
bash
â— boat-system.service - Boat Control System
     Loaded: loaded (/etc/systemd/system/boat-system.service; enabled; preset: enabled)
     Active: active (running) since Mon 2025-08-04 15:25:00 BST; 1min ago
   Main PID: 734 (boat-start.sh)
      Tasks: 3 (limit: 415)
        CPU: 12.345s
     CGroup: /system.slice/boat-system.service
             â”œâ”€734 /bin/bash /usr/local/bin/boat-start.sh
             â”œâ”€789 /home/pi/mjpg-streamer/mjpg-streamer-experimental/mjpg_streamer -o "output_http.so -w ./www" -i "input_raspicam.so -x 640 -y 480 -fps 15"
             â””â”€791 python3 /home/pi/bridge.py
ðŸ“ Final Verification
Reboot your Pi:

bash
sudo reboot
After reboot:

bash
systemctl status boat-system
nmcli con show --active
Connect your PC to "BoatController" WiFi

Access camera at http://192.168.50.1:8080






Step 1: Check Detailed Service Status
bash
journalctl -u boat-system.service -b --no-pager
Step 2: Check Script Execution Permissions
bash
ls -l /usr/local/bin/boat-start.sh
If not executable:

bash
sudo chmod +x /usr/local/bin/boat-start.sh
Step 3: Test the Script Manually
bash
sudo /usr/local/bin/boat-start.sh
Step 4: Common Fixes Based on Patterns
Fix 1: Network Manager Dependency (Most Likely)
bash
sudo nano /etc/systemd/system/boat-system.service
Add this under [Unit]:

ini
Requires=NetworkManager.service
After=NetworkManager.service
Fix 2: Add Startup Delay
bash
sudo nano /usr/local/bin/boat-start.sh
Add at the top:

bash
#!/bin/bash
sleep 10  # Wait for network initialization
Fix 3: Specify Full Paths
bash
sudo nano /usr/local/bin/boat-start.sh
Update to:

bash
#!/bin/bash

# Start WiFi hotspot
/usr/bin/nmcli con up BoatHotspot

# Start camera stream
/usr/local/bin/start_stream.sh &

# Start UDP-UART bridge
/usr/bin/python3 /home/pi/bridge.py
Step 5: Enable Logging
bash
sudo nano /usr/local/bin/boat-start.sh
Update to:

bash
#!/bin/bash

# Create log file
LOG=/home/pi/boat-start.log
echo "$(date) - Starting boat system" > $LOG

# Start WiFi hotspot
echo "Starting WiFi hotspot" >> $LOG
/usr/bin/nmcli con up BoatHotspot 2>&1 >> $LOG

# Start camera stream
echo "Starting camera stream" >> $LOG
/usr/local/bin/start_stream.sh 2>&1 >> $LOG &

# Start UDP-UART bridge
echo "Starting bridge" >> $LOG
/usr/bin/python3 /home/pi/bridge.py 2>&1 >> $LOG

echo "All components started" >> $LOG
Step 6: Update Service Configuration
bash
sudo nano /etc/systemd/system/boat-system.service
Change to:

ini
[Unit]
Description=Boat Control System
After=network.target
Requires=NetworkManager.service

[Service]
Type=forking
ExecStart=/usr/local/bin/boat-start.sh
WorkingDirectory=/home/pi
Restart=on-failure
RestartSec=10
User=pi

[Install]
WantedBy=multi-user.target
Step 7: Apply Changes
bash
sudo systemctl daemon-reload
sudo systemctl reset-failed boat-system
sudo systemctl start boat-system
Step 8: Verify
bash
systemctl status boat-system
cat /home/pi/boat-start.log
